---
layout: post
title:  "VPP NAT module investigation"
date:   2019-04-01 12:00:00
categories: VPP
tags: VPP NAT
excerpt: Analyze VPP NAT module
mathjax: true
---
# 1. dslite_ce_decap
DS-Lite customer edge decapsulation.

## 1.1. Introduction
There is 1 node: dslite_ce_decap_node.

# 2. dslite_ce_encap
DS-Lite customer edge encapsulation.

## 2.1. Introduction
There is 1 node: dslite_ce_encap_node.

# 3. dslite_cli

## 3.1. Introduction
This module is not a node, and it provide commands for dual-stack lite.

## 3.2. Command
```
dslite add pool address <ip4-range-start> [- <ip4-range-end>]
 [del]
```
```
show dslite pool
```
```
dslite set aftr-tunnel-endpoint-address <ip6>
```
```
show dslite aftr-tunnel-endpoint-address
```
```
dslite set b4-tunnel-endpoint-address <ip6>
```
```
show dslite b4-tunnel-endpoint-address
```
```
show dslite sessions
```

# 4. dslite_dpo
DS-Lite data path object.

## 4.1. Introduction
This module is not a node.

A Data-Path Object is an object that represents actions that are applied to packets as they are switched through VPPâ€™s data-path.

# 5. dslist_in2out

## 5.1. Introduction
There are 2 nodes: dslite_in2out_node and dslite_in2out_slowpath_node.

# 6. dslite_out2in

## 6.1. Introduction
There is 1 node: dslite_out2in_node.

# 7. dslite

## 7.1. Introduction
This is not a node.

Dual-Stack Lite enables a broadband service provider to share IPv4 addresses among customers by combining two well-known technologies: IPv4-in-IPv6 and NAT.

# 8. in2out_ed

## 8.1. Introduction
NAT44 endpoint-dependent inside to outside network translation.

There are 6 nodes:
* nat44_ed_in2out_node
* nat44_ed_in2out_output_node
* nat44_ed_in2out_slowpath_node
* nat44_ed_in2out_output_slowpath_node
* nat44_ed_in2out_reass_node
* nat44_ed_in2out_reass_output_node

NAT44 endpoint dependent mode enables endpoint dependent filtering and mapping for all sessions needed by some features. Some existing functionality such as service load balancing, twice nat, out2in-only static mappings, unknown protocol dynamic translations and forwarding feature with dynamic translations are now available only in endpoint dependent mode. Endpoint dependent mode use 6-tuple (source IP address, source port, target IP address, target port, protocol, FIB table index) session hash table key instead of 4-tuple (source IP address, source port, protocol, FIB table index).

## 8.2. Detail

### 8.2.1. snat_main_per_thread_data_t
This is per thread data.
```
typedef struct
{
  /* Main lookup tables */
  clib_bihash_8_8_t out2in;
  clib_bihash_8_8_t in2out;

  /* Endpoint dependent sessions lookup tables */
  clib_bihash_16_8_t out2in_ed;
  clib_bihash_16_8_t in2out_ed;

  /* Find-a-user => src address lookup */
  clib_bihash_8_8_t user_hash;

  /* User pool */
  snat_user_t *users;

  /* Session pool */
  snat_session_t *sessions;

  /* Pool of doubly-linked list elements */
  dlist_elt_t *list_pool;

  /* NAT thread index */
  u32 snat_thread_index;
} snat_main_per_thread_data_t;
```
#### 8.2.1.1. in2out_ed
This is endpoint dependent sessions lookup tables, and it's VPP classic Bounded-index extensible hash.

* Key is source address, destination address, protocol, fib index, source port and destination port.

* Value is session index.

#### 8.2.1.2. list_pool
This is LRU list for session, and it's doubly-linked list.
* Value is session index.

# 9. in2out

## 9.1. Introduction
NAT44 inside to outside network translation.



