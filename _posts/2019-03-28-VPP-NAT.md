---
layout: post
title:  "VPP NAT module investigation"
date:   2019-04-01 12:00:00
categories: VPP
tags: VPP NAT
excerpt: Analyze VPP NAT module
mathjax: true
---
# 1. dslite_ce_decap
DS-Lite customer edge decapsulation.

## 1.1. Introduction
There is 1 node: dslite_ce_decap_node.

# 2. dslite_ce_encap
DS-Lite customer edge encapsulation.

## 2.1. Introduction
There is 1 node: dslite_ce_encap_node.

# 3. dslite_cli

## 3.1. Introduction
This module is not a node, and it provide commands for dual-stack lite.

## 3.2. Command
```
dslite add pool address <ip4-range-start> [- <ip4-range-end>]
 [del]
```
```
show dslite pool
```
```
dslite set aftr-tunnel-endpoint-address <ip6>
```
```
show dslite aftr-tunnel-endpoint-address
```
```
dslite set b4-tunnel-endpoint-address <ip6>
```
```
show dslite b4-tunnel-endpoint-address
```
```
show dslite sessions
```

# 4. dslite_dpo
DS-Lite data path object.

## 4.1. Introduction
This module is not a node.

A Data-Path Object is an object that represents actions that are applied to packets as they are switched through VPPâ€™s data-path.

# 5. dslist_in2out

## 5.1. Introduction
There are 2 nodes: dslite_in2out_node and dslite_in2out_slowpath_node.

# 6. dslite_out2in

## 6.1. Introduction
There is 1 node: dslite_out2in_node.

# 7. dslite

## 7.1. Introduction
This is not a node.

Dual-Stack Lite enables a broadband service provider to share IPv4 addresses among customers by combining two well-known technologies: IPv4-in-IPv6 and NAT.

# 8. in2out_ed

## 8.1. Introduction
NAT44 endpoint-dependent inside to outside network translation.

There are 6 nodes:
* nat44_ed_in2out_node
* nat44_ed_in2out_output_node
* nat44_ed_in2out_slowpath_node
* nat44_ed_in2out_output_slowpath_node
* nat44_ed_in2out_reass_node
* nat44_ed_in2out_reass_output_node

NAT44 endpoint dependent mode enables endpoint dependent filtering and mapping for all sessions needed by some features. Some existing functionality such as service load balancing, twice nat, out2in-only static mappings, unknown protocol dynamic translations and forwarding feature with dynamic translations are now available only in endpoint dependent mode. Endpoint dependent mode use 6-tuple (source IP address, source port, target IP address, target port, protocol, FIB table index) session hash table key instead of 4-tuple (source IP address, source port, protocol, FIB table index).

## 8.2. Detail

### 8.2.1. snat_main_per_thread_data_t
This is per thread data.
```
typedef struct
{
  /* Main lookup tables */
  clib_bihash_8_8_t out2in;
  clib_bihash_8_8_t in2out;

  /* Endpoint dependent sessions lookup tables */
  clib_bihash_16_8_t out2in_ed;
  clib_bihash_16_8_t in2out_ed;

  /* Find-a-user => src address lookup */
  clib_bihash_8_8_t user_hash;

  /* User pool */
  snat_user_t *users;

  /* Session pool */
  snat_session_t *sessions;

  /* Pool of doubly-linked list elements */
  dlist_elt_t *list_pool;

  /* NAT thread index */
  u32 snat_thread_index;
} snat_main_per_thread_data_t;
```
#### 8.2.1.1. in2out_ed
This is endpoint dependent sessions lookup tables, and it's VPP classic Bounded-index extensible hash.

* Key is source address, destination address, protocol, fib index, source port and destination port.

* Value is session index.

#### 8.2.1.2. list_pool
This is LRU list for session, and it's doubly-linked list.
* Value is session index.

#### 8.2.1.3. sessions
```
typedef CLIB_PACKED(struct
{
  /* Outside network key */
  snat_session_key_t out2in;

  /* Inside network key */
  snat_session_key_t in2out;

  /* Flags */
  u32 flags;

  /* Per-user translations */
  u32 per_user_index;
  u32 per_user_list_head_index;

  /* Last heard timer */
  f64 last_heard;

  /* Last HA refresh */
  f64 ha_last_refreshed;

  /* Counters */
  u64 total_bytes;
  u32 total_pkts;

  /* External host address and port */
  ip4_address_t ext_host_addr;
  u16 ext_host_port;

  /* External host address and port after translation */
  ip4_address_t ext_host_nat_addr;
  u16 ext_host_nat_port;

  /* TCP session state */
  u8 state;
  u32 i2o_fin_seq;
  u32 o2i_fin_seq;

  /* user index */
  u32 user_index;
}) snat_session_t;
```
* out2in is outside network key.
* in2out is inside network key.
* last_heard is the timestamp used to mark timeout session.

### 8.2.2. nat44_ed_in2out_node
This node is used before ip4-lookup.

This node is using nat44_ed_in2out_node_fn_inline(). is_slow_path is 0, and is_output_feature is 0.

* Default next node is NAT_IN2OUT_ED_NEXT_LOOKUP.
* Locate IP header, offset is 0.
* If IP ttl is 0, next node is NAT_IN2OUT_ED_NEXT_ICMP_ERROR.
* If IP protocol is not UDP, TCP and ICMP, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* If it's IP fragment, next node is NAT_IN2OUT_ED_NEXT_REASS.
* If IP protocol is ICMP, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* Use source address, destination address, protocol, fib index, source port and destination port to search in2out_ed table.
* If this search has no result, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* If this search has result, use result to get session.
* Replace src address, update IP checksum.
* If IP protocol is TCP, replace source port, update IP checksum, update TCP checksum.
* If IP protocol is UDP, replace source port, UDP checksum is 0.
* Update session counter and timestamp. Timestamp is used to mark timeout session.
* Update doubly-linked list, move session index to list tail.

### 8.2.3. nat44_ed_in2out_output_node
This node is used and after l2-fwd and l3-fwd, before interface-lookup.

This node is using nat44_ed_in2out_node_fn_inline(). is_slow_path is 0, and is_output_feature is 1.

* Default next node is NAT_IN2OUT_ED_NEXT_LOOKUP.
* Locate IP header, offset is save_rewrite_length.
* If IP ttl is 0, next node is NAT_IN2OUT_ED_NEXT_ICMP_ERROR.
* If IP protocol is not UDP, TCP and ICMP, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* If it's IP fragment, next node is NAT_IN2OUT_ED_NEXT_REASS.
* nat_not_translate_output_feature_fwd()
   * Search in2out_ed table for ICMP, TCP and UDP.
   * If this search has result, , use result to get session.
   * If this session is bypass, update session counter and timestamp, and update doubly-linked list.
* If IP protocol is ICMP, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* Use source address, destination address, protocol, fib index, source port and destination port to search in2out_ed table.
* If this search has no result, next node is NAT_IN2OUT_ED_NEXT_SLOW_PATH.
* If this search has result, use result to get session.
* Replace src address, update IP checksum.
* If IP protocol is TCP, replace source port, update IP checksum, update TCP checksum.
* If IP protocol is UDP, replace source port, UDP checksum is 0.
* Update session counter and timestamp. Timestamp is used to mark timeout session.
* Update doubly-linked list, move session index to list tail.

### 8.2.4. nat44_ed_in2out_slowpath_node
This node is used after nat44-ed-in2out, before ip4-lookup.

This node is using nat44_ed_in2out_node_fn_inline(). is_slow_path is 1, and is_output_feature is 0.



# 9. in2out

## 9.1. Introduction
NAT44 inside to outside network translation.



